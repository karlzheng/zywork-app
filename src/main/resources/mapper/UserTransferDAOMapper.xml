<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="top.zywork.dao.UserTransferDAO">

    <insert id="saveTransfer">
        <!-- 只有当可用余额大于等于转账金额加所有未完成的提现金额时才可转账 -->
        insert into t_funds_transfer(user_id, amount, to_user_id, transfer_type)
        select #{userId}, #{amount}, #{toUserId}, #{transferType} from dual
        where exists(
        select t_user_wallet.usable_rmb_balance as usableRmbBalance,
        (select ifnull(sum(t_funds_withdraw.amount), 0)
        from t_funds_withdraw where t_funds_withdraw.user_id = #{userId} and t_funds_withdraw.complete_time is null) as withdrawAmount
        from t_user_wallet where t_user_wallet.id = #{userId}
        having usableRmbBalance - withdrawAmount >= #{amount})
    </insert>

    <insert id="saveTransferTo">
        insert into t_funds_transfer(user_id, amount, from_user_id, transfer_type)
        values (#{userId}, #{amount}, #{fromUserId}, #{transferType})
    </insert>

</mapper>
